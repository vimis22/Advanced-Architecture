services:
  mosquitto:
    image: eclipse-mosquitto:2.0.18   # pin a known-good version
    restart: unless-stopped
    ports:
      - "${MQTT_TCP_PORT:-1883}:1883"       # MQTT TCP for Picos / tools
      - "${MQTT_WS_PORT:-8080}:8080"        # MQTT over WebSockets for dashboard
    volumes:
      # map your actual conf file path
      - ./config/mosquitto.conf:/mosquitto/config/mosquitto.conf:ro
      # optional: if you use these, map them too
      - ./config/passwords:/mosquitto/config/passwords:rw
      - ./config/acl:/mosquitto/config/acl:ro
      # data/log dirs (persisted as local folders)
      - ./data:/mosquitto/data
      - ./log:/mosquitto/log

  dashboard:
    build: ./mqtt-dashboard
    restart: unless-stopped
    environment:
      - DASH_DEFAULT_WS=${DASH_DEFAULT_WS:-ws://localhost:8080/mqtt}
    ports:
      - "${DASH_PORT:-8085}:80"
    depends_on:
      - mosquitto

volumes:
  mosq-data:
  mosq-log:

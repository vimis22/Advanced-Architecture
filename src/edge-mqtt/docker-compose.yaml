services:
  mosquitto:
    image: eclipse-mosquitto:2.0.18
    container_name: mosquitto
    restart: unless-stopped
    ports:
      - "1883:1883"
      - "8080:8080"
    volumes:
      - ./config/mosquitto.conf:/mosquitto/config/mosquitto.conf:ro
      - ./data:/mosquitto/data
      - ./log:/mosquitto/log
      # uncomment if you enabled auth/ACL
      # - ./config/passwords:/mosquitto/config/passwords:rw
      # - ./config/acl:/mosquitto/config/acl:ro

  dashboard:
    image: nginx:1.27-alpine
    container_name: mqtt-dashboard
    restart: unless-stopped
    ports:
      - "8081:80"
    volumes:
      - ./dashboard:/usr/share/nginx/html:ro

  simulator:
    build: ./simulator
    restart: unless-stopped
    depends_on:
      - mosquitto
    environment:
      # broker
      BROKER_HOST: mosquitto
      BROKER_PORT: "1883"
      # remove if mosquitto is still anonymous
      # BROKER_USER: mqttuser
      # BROKER_PASS: mqttpass

      # MQTT topic layout
      BASE_TOPIC: pico
      TELEMETRY_TOPIC_SUFFIX: telemetry
      STATUS_TOPIC_SUFFIX: status
      CMD_TOPIC_SUFFIX: cmd

      # profile distribution (auto-assigned per container)
      PROFILE_DIST: "fast:10,normal:70,slow:20"

      # per-profile settings
      PROFILE_FAST_INTERVAL_MS: "200"
      PROFILE_FAST_JITTER_MS: "50"

      PROFILE_NORMAL_INTERVAL_MS: "1000"
      PROFILE_NORMAL_JITTER_MS: "200"

      PROFILE_SLOW_INTERVAL_MS: "10000"
      PROFILE_SLOW_JITTER_MS: "500"

      EXTRA_TAGS: "location=lab,batch=sim"

<!doctype html>
<meta charset="utf-8">
<title>MQTT Dashboard</title>
<style>
  body{font-family:system-ui;margin:20px}
  .row{display:flex;gap:8px;align-items:center;margin-bottom:12px;flex-wrap:wrap}
  table{border-collapse:collapse;width:100%}
  th,td{border:1px solid #ddd;padding:6px;font-family:ui-monospace,Consolas,monospace}
  th{background:#f5f5f5} tr:nth-child(even){background:#fafafa}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px;margin:12px 0}
  .card{border:1px solid #ddd;border-radius:10px;padding:10px}
  .id{font-weight:600;margin-bottom:8px}
  button{padding:6px 10px;cursor:pointer}
  .btns{display:flex;gap:8px;flex-wrap:wrap}
  .badge{padding:2px 8px;border-radius:999px;background:#eee}
  .ok{background:#d1fae5} .warn{background:#fde68a} .err{background:#fecaca}
  #console{border:1px solid #ddd;border-radius:8px;padding:8px;height:120px;overflow:auto;font-family:ui-monospace,Consolas,monospace;background:#fafafa}
  .muted{opacity:.8}
</style>

<h2>MQTT Dashboard</h2>

<div class="row">
  <label>Broker WS URL:</label>
  <input id="url" size="36" value="ws://10.126.128.127/mqtt">
  <button id="connect">Connect</button>
  <span id="status" class="badge">disconnected</span>
</div>

<div class="row">
  <label>Subscribe topic:</label>
  <input id="sub" size="40" value="#">
  <button id="subBtn">Subscribe</button>
  <span class="muted">Tip: use <code>#</code> to see all</span>
</div>

<div class="row">
  <label>Add device ID:</label>
  <input id="addDev" placeholder="pico-xx">
  <button id="addBtn">Add</button>
  <span class="muted">(buttons publish to <code>pico/&lt;device&gt;/cmd</code>)</span>
</div>

<h3>Quick controls</h3>
<div id="deviceGrid" class="grid"></div>

<h3>Messages</h3>
<table>
  <thead><tr><th>Time</th><th>Topic</th><th>Payload</th></tr></thead>
  <tbody id="log"></tbody>
</table>

<h3>Console</h3>
<div id="console"></div>

<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script>
  const DEVICES = new Set(JSON.parse(localStorage.getItem("devices") || "[]"));
  const saveDevices = () => localStorage.setItem("devices", JSON.stringify([...DEVICES]));
  let client = null;

  const logEl=document.getElementById('log');
  const gridEl=document.getElementById('deviceGrid');
  const consoleEl=document.getElementById('console');
  const statusEl=document.getElementById('status');

  const clog=(level,msg)=>{
    const el=document.createElement('div');
    el.textContent=`[${new Date().toLocaleTimeString()}] ${msg}`;
    el.className = (level==="ok"?"ok":level==="warn"?"warn":"err");
    consoleEl.appendChild(el); consoleEl.scrollTop=consoleEl.scrollHeight;
  };
  const msglog=(topic,payload)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${new Date().toLocaleTimeString()}</td><td>${topic}</td><td>${payload}</td>`;
    logEl.prepend(tr); if(logEl.rows.length>500) logEl.deleteRow(500);
  };

  function renderDevices(){
    gridEl.innerHTML="";
    [...DEVICES].sort().forEach(id=>{
      const card=document.createElement('div'); card.className='card';
      card.innerHTML=`
        <div class="id">${id}</div>
        <div class="btns">
          <button data-id="${id}" data-cmd="led_on">LED ON</button>
          <button data-id="${id}" data-cmd="led_off">LED OFF</button>
        </div>`;
      gridEl.appendChild(card);
    });
  }

  function publish(topic, payload){
    if(!client || !client.connected){ clog("err","Not connected; publish skipped"); return; }
    const text = typeof payload==="string" ? payload : JSON.stringify(payload);
    client.publish(topic, text, {qos:1});
    msglog("(publish)", `${topic} = ${text}`);
  }
  function publishCmd(id, cmd){ publish(`pico/${id}/cmd`, cmd); }

  gridEl.addEventListener('click',(e)=>{
    const btn=e.target.closest('button'); if(!btn) return;
    const id=btn.dataset.id;
    if(btn.dataset.cmd){ publishCmd(id, btn.dataset.cmd); }
    else if(btn.dataset.test){
      publishCmd(id,"led_on");
      setTimeout(()=> publishCmd(id,"led_off"), 700);
    }
  });

  document.getElementById('addBtn').onclick=()=>{
    const id=document.getElementById('addDev').value.trim();
    if(!id) return;
    DEVICES.add(id); saveDevices(); renderDevices();
    clog("ok",`Added device ${id}`);
    document.getElementById('addDev').value="";
  };

  document.getElementById('connect').onclick=()=>{
    if(client) client.end(true);
    const url=document.getElementById('url').value.trim();
    const username=document.getElementById('user').value.trim();
    const password=document.getElementById('pass').value;
    const opts={clean:true};
    if(username) Object.assign(opts,{username,password});
    client=mqtt.connect(url, opts);

    statusEl.textContent="connecting…"; statusEl.className="badge warn";
    clog("warn",`Connecting to ${url} …`);

    client.on('connect',()=>{
      statusEl.textContent="connected"; statusEl.className="badge ok";
      clog("ok","Connected");
    });
    client.on('reconnect',()=>{ statusEl.textContent="reconnecting…"; statusEl.className="badge warn"; clog("warn","Reconnecting…"); });
    client.on('close',()=>{ statusEl.textContent="disconnected"; statusEl.className="badge"; clog("err","Disconnected"); });
    client.on('error',(err)=>{ clog("err","Error: "+err.message); });

    client.on('message',(topic,message)=>{
      const text=message.toString();
      msglog(topic,text);
      const m=topic.match(/^pico\/([^/]+)\/(status|telemetry|cmd)$/);
      if(m){ const id=m[1]; if(!DEVICES.has(id)){ DEVICES.add(id); saveDevices(); renderDevices(); clog("ok",`Auto-added ${id}`); } }
    });

    renderDevices();
  };

  document.getElementById('subBtn').onclick=()=>{
    if(!client) return alert('Connect first');
    const topic=document.getElementById('sub').value.trim()||'#';
    client.subscribe(topic,{qos:1},(err)=>{ if(err) clog("err","Subscribe failed: "+err.message); else clog("ok","Subscribed to "+topic); });
    msglog('(subscribed)', topic);
  };

  renderDevices();
</script>

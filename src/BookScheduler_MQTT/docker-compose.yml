version: "3.9"

services:
  # -------------------------
  # PostgreSQL
  # -------------------------
  postgres:
    image: postgres:15
    container_name: bookscheduler_postgres
    restart: always
    environment:
      POSTGRES_DB: bookscheduler
      POSTGRES_USER: buser
      POSTGRES_PASSWORD: bpass
    ports:
      - "5432:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data

  # -------------------------
  # Eclipse Mosquitto (MQTT)
  # -------------------------
  mqtt:
    image: eclipse-mosquitto:2
    container_name: bookscheduler_mqtt
    restart: always
    ports:
      - "1883:1883"
      - "9001:9001"
    volumes:
      - ./mosquitto.conf:/mosquitto/config/mosquitto.conf

  # -------------------------
  # BookScheduler App
  # -------------------------
  scheduler:
    image: sirstehn/bookscheduler-mqtt:latest
    build:
      context: .
      dockerfile: Dockerfile
    container_name: book_scheduler
    restart: always
    depends_on:
      - postgres
      - mqtt
    environment:
      ConnectionStrings__Postgres: "Host=postgres;Port=5432;Database=bookscheduler;Username=buser;Password=bpass"
      Mqtt__Host: mqtt
      Mqtt__Port: 1883
    ports:
      - "5000:5000"

# -------------------------
# DEFINE VOLUMES
# -------------------------
volumes:
  pgdata:
